# 30 — Time & Attendance

## Feature: Time Clock Integration
- Description: Import attendance data via Excel files into the Donneespointeuse table; handle punch-in/out pairs per employee.
- User Story: As a payroll clerk, I import time punches from Excel to populate in/out events for each employee and period.
- Acceptance Criteria:
  - Supported input: XLS with columns for IN/OUT timestamps, weekend flag, and employee code (Source: util/ReadExcel.java — read(): uses sheet cells at indices 1,2,7,8 and parses dates).
  - For each row with valid IN and OUT, create two Donneespointeuse entries: vinOut = 'I' for IN and 'O' for OUT; mark importe=true (Source: util/ReadExcel.java — insert two records; entity/Donneespointeuse.java).
  - Only import records after a configured beginDate; allow pre-clean of existing pointage from beginDate (Source: util/ReadExcel.java — deletePointageFromDateAll(true, beginDate)).
  - Employee matching by external pointer id (idSalarie) mapped to Employe via employeByIDP or employeByIdPsservice (Source: util/ReadExcel.java).
  - Error handling: skip invalid rows; log/trace parsing exceptions (Source: util/ReadExcel.java — try/catch with e.printStackTrace()).
- Business Rules:
  - IN must precede OUT; discard pairs with invalid ordering (assumption — not enforced in legacy code; add validation in new impl).
  - Weekend/holiday flags may influence premiums later but are stored downstream (Source: util/ReadExcel.java references dayWE; entity/Jour has ferie50/100 booleans).
- Dependencies: Employee profiles with pointer IDs; period configuration (Source: entity/Employe.java — idSalariePointeuse, idPsservice; entity/Paramgen.java — periodeCourante).

## Feature: Attendance Processing
- Description: Transform daily punches into per-day aggregates and weekly overtime summaries; compute NJT days for payroll.
- Acceptance Criteria:
  - Daily aggregates stored in Jour with nbHeureJour, nbHeureNuit, ferie50, ferie100, siteExterne, primes counters (Source: entity/Jour.java — fields nbHeureJour, nbHeureNuit, ferie50, ferie100, siteExterne, nbPrimePanier, nbPrimeEloignement, note).
  - Weekly OT totals stored in Weekot with ot115, ot140, ot150, ot200 and prime counters (Source: entity/Weekot.java — fields).
  - Monthly working days (NJT) recorded per employee/motif/period (Source: entity/Njtsalarie.java — unique on periode, employe, motif; util/FonctionsPaie.java F01_NJT reads Njtsalarie).
  - Night hours identified for hours worked after a policy cutoff (assumption: 22:00; store in nbHeureNuit) (Source: entity/Jour.java — nbHeureNuit; cutoff not in code).
  - Holiday premiums flagged per day via ferie50/ferie100 (Source: entity/Jour.java).
- Business Rules:
  - Overtime banding tracked as 115/140/150/200 factors at weekly level (Source: entity/Weekot.java — ot115, ot140, ot150, ot200; thresholds/policies not in code — define in config).
  - NJT definition aligned with HR policy; used by payroll functions (Source: entity/Njtsalarie.java; util/FonctionsPaie.java — F01_NJT).
  - Site externe and primes counters incremented based on worksite or policy (Source: entity/Jour.java, Weekot.java — nbPrimePanier, nbPrimeEloignement, siteExterne).
- Dependencies: Time clock import; work schedules; holiday calendar; motif catalog.

## Feature: Work Schedule Management
- Description: Define week structure and per-employee day/shift applicability.
- Acceptance Criteria:
  - Global week structure table with day name and flags debut (start/open), fin (end/close), weekEnd (weekend) (Source: entity/Semainetravail.java — jour, debut, fin, weekEnd).
  - Per-employee weekly day flags available to mark DS/FS/WE per day (Source: entity/Employe.java — lundi_* … dimanche_* boolean flags).
  - Changes to schedules effective from a chosen date (assumption; not explicit in code); use Paramgen.periodeCourante for default application window (Source: entity/Paramgen.java).
- Business Rules: Schedules drive expected hour totals and overtime thresholds; weekend flag interacts with holiday/premium logic (Source: entity/Semainetravail.java, entity/Employe.java; entity/Weekot.java tracks OT buckets).

## Feature: Advanced Overtime and Premium Calculations
- Description: Compute premiums and OT based on daily and weekly aggregates.
- Inputs: Jour daily totals, Weekot weekly buckets, Semainetravail and employee weekday flags, holiday calendar (Source: entity/Jour.java, Weekot.java, Semainetravail.java, Employe.java).
- Outputs: Rubriquepaie lines generated by payroll engine, not directly in T&A (Source: util/FonctionsPaie.java references pc.empRubriquepaie and cumul functions).
- Notes: Exact thresholds (cutoffs, caps) not encoded in legacy entities — define in Paramgen or a new settings table.

## Feature: Multi-Device Time Clock Integration
- Description: Import pipeline centered on Excel parsing with mapping and validation; missing/duplicate punch handling as data-quality rules.
- Source of truth: Excel-based imports via `util/ReadExcel.java` for punches; additional imports for rubrics and personnel updates supported (Source: util/ReadExcel.java — importeRubriques(), importeDonneesPersonnel()).

## Data Structures (excerpt)
- Donneespointeuse: id, employe, heureJour (timestamp), vinOut ('I'/'O'), importe (Source: entity/Donneespointeuse.java).
- Jour: id, employe, periode, dateJour, nbHeureJour, nbHeureNuit, nbPrimePanier, nbPrimeEloignement, note, ferie50, ferie100, siteExterne (Source: entity/Jour.java).
- Weekot: id, employe, periode, beginweek, endweek, ot115, ot140, ot150, ot200, nbPrimePanier, nbPrimeEloignement, note (Source: entity/Weekot.java).
- Njtsalarie: id, employe, motif, periode, njt (unique per employee+motif+period) (Source: entity/Njtsalarie.java).
- Semainetravail: jour (PK), debut, fin, weekEnd (Source: entity/Semainetravail.java).

## Change Log (from legacy analysis)

- Fixes
  - Replaced generic multi-device claim with confirmed Excel-based import and Donneespointeuse writes (Source: util/ReadExcel.java).
  - Mapped OT bands and daily aggregates to Weekot/Jour fields rather than opaque rules.

- Additions
  - Added data structures section with exact fields and sources.
  - Specified NJT storage and usage in payroll function F01.

- Assumptions
  - Night cutoff (22:00), OT thresholds, and premium rates are policy-driven; not encoded in code — to be configured.
  - Weekend/holiday calendars maintained externally and applied during aggregation.
